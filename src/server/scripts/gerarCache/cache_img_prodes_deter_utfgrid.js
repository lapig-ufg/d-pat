var t = require('tiles-in-bbox'),
	async = require('async'),
	request = require('request');
var bottom = -33.752081
var left = -73.990450
var top = 5.271841
var right = -28.835908
// var layername = process.argv[2]
//var layername = "bi_ce_prodes_desmatamento_100_fip"

var multipleRequests = 10
/*var bbox = { bottom : -33.752081, left : -73.990450, top : 5.271841, right : -28.835908 } //Brazil*/
var bbox = { bottom: -24.6846260, left: -60.1094198, top: -2.3262773, right: -41.5220189 } //Cerrado

var ufs = ['GO', 'SP', 'MA', 'RO', 'PA', 'MS', 'TO', 'MT', 'PR', 'PI', 'BA', 'DF', 'MG']

var muns = getMunsCerrado();

var layers = ["bi_ce_prodes_desmatamento_100_fip_utfgrid", "bi_ce_deter_desmatamento_100_fip_utfgrid"]

var years = [2002, 2004, 2006, 2008, 2010, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019]

var deterYears = ["view_date > '2018-01-01'", "view_date > '2019-01-01'", "view_date > '2020-01-01'"]

var urls = []

var types = ['none']
// var types = ['state']
// var types = ['city']
// for (var uf = 0; uf < ufs.length; uf++) {

for (let type of types) {

	if (type == 'none') {

		for (let layername of layers) {

			if (layername == "bi_ce_prodes_desmatamento_100_fip") {

				for (var year = (years.length - 1); year >= 0; year--) {
					// console.log("Year: " + years[year])
					for (var zoom = 0; zoom <= 12; zoom++) {
						var tiles = t.tilesInBbox(bbox, zoom)

						tiles.forEach(function (tile) {
							var url = "http://127.0.0.1:3000/ows"
								+ "?layers=" + layername
								+ "&mode=tile"
								+ "&tilemode=gmap"
								// + "&map.imagetype=png"
								+ "&map.imagetype=utfgrid"
								+ "&tile=" + [tile.x, tile.y, tile.z].join('+')

							url += "&MSFILTER=year=" + years[year]


							// console.log(url)
							urls.push(url)
						})
					}
				}
			}
			else {
				for (var year = (deterYears.length - 1); year >= 0; year--) {
					// console.log("Year: " + years[year])
					for (var zoom = 0; zoom <= 12; zoom++) {
						var tiles = t.tilesInBbox(bbox, zoom)

						tiles.forEach(function (tile) {
							var url = "http://127.0.0.1:3000/ows"
								+ "?layers=" + layername
								+ "&mode=tile"
								+ "&tilemode=gmap"
								// + "&map.imagetype=png"
								+ "&map.imagetype=utfgrid"
								+ "&tile=" + [tile.x, tile.y, tile.z].join('+')

							url += "&MSFILTER=" + deterYears[year]

							// console.log(url)
							urls.push(url)
						})
					}
				}
			}
		}
	}
	else if (type == 'city') {
		for (let mun of muns) {

			for (let layername of layers) {

				if (layername == "bi_ce_prodes_desmatamento_100_fip") {

					for (var year = (years.length - 1); year >= 0; year--) {
						// console.log("Year: " + years[year])
						for (var zoom = 0; zoom <= 12; zoom++) {
							var tiles = t.tilesInBbox(bbox, zoom)

							tiles.forEach(function (tile) {
								var url = "http://127.0.0.1:3000/ows"
									+ "?layers=" + layername
									+ "&mode=tile"
									+ "&tilemode=gmap"
									// + "&map.imagetype=png"
									+ "&map.imagetype=utfgrid"
									+ "&tile=" + [tile.x, tile.y, tile.z].join('+')

								url += "&MSFILTER=year=" + years[year] + " AND cd_geocmu = '" + mun + "'"


								// console.log(url)
								urls.push(url)
							})
						}
					}
				}
				else {
					for (var year = (deterYears.length - 1); year >= 0; year--) {
						// console.log("Year: " + years[year])
						for (var zoom = 0; zoom <= 12; zoom++) {
							var tiles = t.tilesInBbox(bbox, zoom)

							tiles.forEach(function (tile) {
								var url = "http://127.0.0.1:3000/ows"
									+ "?layers=" + layername
									+ "&mode=tile"
									+ "&tilemode=gmap"
									// + "&map.imagetype=png"
									+ "&map.imagetype=utfgrid"
									+ "&tile=" + [tile.x, tile.y, tile.z].join('+')

								url += "&MSFILTER=" + deterYears[year] + " AND cd_geocmu = '" + mun + "'"

								// console.log(url)
								urls.push(url)
							})
						}
					}
				}
			}

		}
	}
	else if (type == 'state') {
		for (let uf of ufs) {
			for (let layername of layers) {

				if (layername == "bi_ce_prodes_desmatamento_100_fip") {

					for (var year = (years.length - 1); year >= 0; year--) {
						// console.log("Year: " + years[year])
						for (var zoom = 0; zoom <= 11; zoom++) {
							var tiles = t.tilesInBbox(bbox, zoom)

							tiles.forEach(function (tile) {
								var url = "http://127.0.0.1:3000/ows"
									+ "?layers=" + layername
									+ "&mode=tile"
									+ "&tilemode=gmap"
									// + "&map.imagetype=png"
									+ "&map.imagetype=utfgrid"
									+ "&tile=" + [tile.x, tile.y, tile.z].join('+')

								url += "&MSFILTER=year=" + years[year] + " AND uf = '" + uf + "'"


								// console.log(url)
								urls.push(url)
							})
						}
					}
				}
				else {
					for (var year = (deterYears.length - 1); year >= 0; year--) {
						// console.log("Year: " + years[year])
						for (var zoom = 0; zoom <= 11; zoom++) {
							var tiles = t.tilesInBbox(bbox, zoom)

							tiles.forEach(function (tile) {
								var url = "http://127.0.0.1:3000/ows"
									+ "?layers=" + layername
									+ "&mode=tile"
									+ "&tilemode=gmap"
									// + "&map.imagetype=png"
									+ "&map.imagetype=utfgrid"
									+ "&tile=" + [tile.x, tile.y, tile.z].join('+')

								url += "&MSFILTER=" + deterYears[year] + " AND uf = '" + uf + "'"

								// console.log(url)
								urls.push(url)
							})
						}
					}
				}
			}
		}
	}
}


var requests = []

urls.forEach(function (url) {
	requests.push(function (next) {
		console.log("Caching " + url)
		request(url, function (error, response, body) {
			next()
		});
	});
})

async.parallelLimit(requests, multipleRequests)



function getMunsCerrado() {
	return ['5200050', '3100104', '5200100', '3100203', '5100102', '5200134', '5200159', '5100201', '5000203', '3100708', '5200175', '5200209', '3500303', '3100807', '3500550', '3500600', '5200258', '3500709', '3500758', '5000252', '5200308', '5200506', '3101904', '3500907', '3501004', '5100300', '5100359', '5100409', '5200555', '5100508', '5200605', '5100607', '2200400', '3501202', '3501509', '5200803', '5200829', '2200509', '3501608', '5200852', '3501707', '3501806', '5200902', '3502002', '5201108', '5000708', '5000807', '3502200', '3102852', '5000856', '5201207', '3502309', '5201306', '5000906', '5201405', '5201454', '5001003', '3502705', '5201504', '5001102', '3103207', '5201603', '5201702', '5201801', '5101001', '5101209', '5202155', '3103504', '5001243', '3503000', '3503109', '4101606', '3103801', '5101258', '3503208', '3503307', '2101004', '3103900', '3104007', '3104106', '3104205', '3503406', '3503604', '5101308', '5202353', '3104502', '1702406', '3503802', '5202502', '3504008', '3104809', '5202601', '3504305', '3504503', '5202809', '3105004', '5203104', '3504800', '3105103', '5001508', '3105400', '3505203', '2902708', '3505302', '5101704', '5101803', '2201200', '3505500', '3505609', '5203203', '5001904', '3505906', '5002001', '3506003', '3506102', '5002100', '5203302', '3106200', '3106507', '3106705', '3107000', '3107109', '3506706', '3506805', '3107307', '5002159', '3506904', '3107406', '5203401', '5203500', '3107703', '5101852', '3507159', '5203559', '3108206', '5002209', '3108255', '5203575', '3507407', '3507456', '3507506', '3108503', '5002308', '3108552', '5300108', '3108602', '5101902', '5203609', '2102150', '2904407', '5203807', '3507803', '3507902', '3109204', '3508009', '5203906', '5203939', '2202000', '5203962', '2904753', '3109303', '3508207', '3109402', '5002407', '3109451', '5204003', '3508306', '5102504', '5204102', '3109600', '5204201', '3109808', '5204250', '2102374', '5204300', '3109907', '3110004', '5204409', '3509403', '5204508', '5204557', '5002605', '5204607', '3509452', '3111101', '5204656', '5102603', '3509502', '5204706', '5204805', '3111150', '3111200', '3111309', '3111408', '5002704', '2202174', '5204854', '5102637', '5102678', '3111507', '5204904', '5102686', '3111606', '3509809', '5204953', '3111804', '5102702', '2202251', '3112000', '3510005', '3510104', '2202307', '3510203', '3112307', '3112406', '3112505', '3112604', '3112703', '3112802', '2202505', '5002803', '3113503', '3510708', '3114006', '3114204', '3114303', '3114402', '5205000', '3114550', '3510807', '3115003', '3115102', '3510906', '5002902', '5205059', '4104907', '5205109', '5205208', '3115474', '2202653', '3511300', '3115607', '3115805', '5205406', '3511409', '5205455', '3116100', '5103007', '3116159', '5205471', '5002951', '3511706', '5205497', '3116407', '3116506', '3116605', '5103106', '5205513', '2908101', '3512001', '5205521', '3512100', '3116902', '5103304', '3117306', '2103554', '3117504', '3117603', '3512209', '3512308', '3117836', '3117876', '3118106', '3118205', '5103361', '3118601', '3118700', '3118809', '3512407', '3118908', '5003108', '3119104', '3119302', '3512605', '3119500', '3119807', '5205703', '3119955', '5003207', '5205802', '5205901', '3512704', '3512803', '3512902', '5003256', '3120102', '5003306', '3513108', '3120201', '3513207', '3120300', '5206206', '5206305', '5206404', '5206503', '3120706', '5103403', '5206602', '3120870', '3120904', '5206701', '5206800', '3121001', '5206909', '3121209', '3121258', '2203305', '5103452', '3513702', '3121605', '5103502', '5207105', '3122306', '5208301', '3514007', '3514106', '5003488', '5103601', '3122470', '3123205', '3123403', '5003504', '3514304', '3123502', '5003702', '5207253', '3514502', '3514601', '3514700', '5207352', '5207402', '3515152', '3123809', '3124104', '3124302', '3515186', '3515194', '3557303', '3124708', '5207501', '3124807', '5207535', '5207600', '2910776', '3125408', '3125705', '3515608', '3515509', '3515657', '5003900', '5207808', '3515905', '5207907', '3126000', '2203909', '3126109', '5208004', '3126208', '5208103', '3126307', '3126406', '3516200', '3126505', '3126604', '3126703', '3127008', '3127073', '3127107', '3127206', '5208152', '3127339', '5103858', '3516853', '5103908', '3516903', '3127354', '5208400', '5208509', '5208608', '5208707', '5208806', '5208905', '5209101', '3127602', '5209150', '3127800', '3127909', '2204501', '3517406', '3128105', '3517505', '5209200', '3517703', '3517901', '3128253', '5209291', '5209408', '3128600', '3518503', '3518602', '2204550', '5209457', '3518859', '5004106', '3128907', '5104203', '3129103', '5209606', '5209705', '5209804', '3519055', '3519105', '5209903', '3519253', '3519303', '3129509', '3129608', '3129657', '3129707', '3519501', '3519600', '2913200', '3130051', '2105104', '3519808', '3519907', '3520004', '3520103', '3130200', '3130309', '2204659', '3130507', '5209937', '3130655', '3520608', '3130705', '5209952', '3131000', '5210000', '3131109', '5004403', '5210109', '3521101', '3131406', '3521150', '5210158', '5210208', '3521309', '3521408', '3131604', '5210307', '3521705', '5210406', '3131703', '3132008', '3132107', '3132206', '5210562', '5210604', '3521804', '2105351', '5210802', '3521903', '3522000', '3132503', '3132800', '3132909', '5210901', '3133402', '3133501', '3522307', '3522406', '3522604', '5211008', '3522703', '5004502', '3522802', '5211206', '3523206', '5211305', '3523503', '3133758', '5211404', '2205102', '3133808', '5104609', '3523602', '3523701', '3523800', '3134202', '5211503', '3134400', '3524105', '2917334', '5211602', '3524204', '3524303', '3134608', '5104807', '3134806', '4112009', '3524709', '3135050', '3135100', '5211701', '5104906', '3135209', '3135308', '3135357', '5211800', '5004908', '5005004', '3525102', '5211909', '3525300', '5212006', '5105002', '3135456', '3135605', '3135704', '3525409', '2205300', '5212055', '3136306', '3525607', '3136405', '2205458', '2205508', '3136520', '3136579', '5212105', '5105150', '3136801', '2205532', '5105200', '5212204', '3136959', '3137106', '2105708', '2205557', '3137205', '3137304', '3137502', '3137536', '2105963', '3137601', '5212253', '3138104', '3138302', '3526704', '3138351', '3526803', '5212303', '2919405', '3526902', '3138625', '3138658', '5105259', '3527504', '3527603', '2205706', '3138682', '3527801', '3527900', '3138807', '5212501', '2205805', '3528007', '2205854', '3528304', '5212600', '2920205', '5212709', '3139250', '3528601', '3139300', '5212808', '3528809', '5005400', '2106359', '3139706', '3529005', '3140506', '3529203', '5212907', '3529302', '3140852', '2206100', '3141009', '3141108', '5212956', '3141207', '5213004', '3141306', '3529609', '2206209', '3529708', '5213053', '5213087', '3141801', '5213103', '3529807', '3142007', '5005608', '3530300', '3530409', '3142254', '3530508', '3142403', '3530706', '3530805', '5213400', '3142502', '3142700', '5213509', '3142809', '3531308', '3531407', '3142908', '3531506', '3143104', '3143203', '3143302', '5213707', '3143450', '5213756', '5213772', '3143500', '2921609', '5213806', '3531902', '5213855', '3143609', '3143708', '2107100', '5213905', '3532058', '5214002', '5214051', '2922250', '2206696', '5214101', '3532157', '3144375', '2206720', '5214408', '3144607', '5214507', '3532603', '5005806', '5214606', '5105903', '5106000', '5106109', '5006002', '5214705', '5006200', '5214804', '5106208', '3532827', '5214838', '3532900', '5214861', '3533007', '5214879', '5106182', '5108907', '5106224', '5106174', '3533403', '3145000', '3145059', '5214903', '3145208', '5106240', '3136603', '5215009', '5106257', '1715150', '5215207', '5215231', '3533502', '5215256', '5106315', '5106281', '3145372', '3533601', '3533700', '3533809', '3145455', '3533908', '3145802', '3534005', '3534203', '5215306', '3534302', '3534500', '5215405', '5215504', '5215603', '3146255', '3146552', '3146404', '3146503', '3535002', '5215652', '2923407', '2207504', '5215702', '5215801', '5215900', '3535309', '5216007', '3146909', '3147105', '3147006', '3535507', '5006275', '1716208', '5006309', '5216304', '3535804', '5106307', '3147402', '2923704', '5216403', '3536109', '3536257', '2207702', '3147907', '3147956', '3148004', '3148103', '3536307', '2207793', '3536505', '3536570', '3536604', '2108108', '2207850', '3536703', '5106372', '3149150', '3537008', '3149200', '5006408', '3149309', '3149606', '3149705', '3149804', '5216452', '5216809', '2924405', '5216908', '3150505', '2924504', '3538105', '3150570', '5217104', '3538709', '4119400', '3538808', '3150703', '3538907', '5217203', '3151206', '3539301', '3539400', '5217302', '5217401', '3539509', '3151404', '3151503', '5217609', '5106455', '3151602', '3539707', '5106505', '3152006', '5006606', '3540200', '5106653', '5217708', '5106703', '5106752', '3540309', '3152131', '5218003', '5218052', '3152204', '5218102', '2208502', '5106851', '3540705', '5006903', '5218300', '5107008', '3540903', '3152808', '3541059', '3152907', '3153004', '3541109', '3153202', '3153400', '5107040', '5218391', '3153608', '3153707', '3541703', '5218508', '3542206', '3542404', '3542503', '5107156', '3542701', '3154457', '2926400', '3154507', '5218607', '5218706', '5007109', '3542909', '5107180', '3543105', '3154606', '3543204', '3543402', '5107198', '3543600', '3543709', '5007208', '3543907', '3544004', '5007307', '3155504', '3155603', '5218789', '5218805', '5007406', '3156007', '3543501', '5007505', '3156403', '5107602', '5107701', '3156502', '5218904', '3156700', '3156908', '3544905', '3157005', '3545159', '5107750', '5219001', '3545605', '3545803', '5219100', '3546207', '3546256', '3546306', '5219209', '3157377', '3546405', '3546504', '5219258', '3157609', '5219308', '5219357', '3157708', '3546900', '3157807', '3547007', '2110203', '5219407', '5219456', '5007554', '3547502', '5107768', '3159704', '5219506', '3547601', '5219605', '5219704', '3159803', '3158508', '3159001', '3547908', '5219712', '5219738', '3548005', '5219753', '5107792', '5107800', '3160405', '3160454', '3160603', '3548906',
		'5219803', '5107859', '3161106', '5219902', '3161304', '5007695', '3161700', '3161809', '3161908', '3125507', '3162104', '3162203', '5220009', '3549102', '3162252', '5220058', '3162401', '3162450', '3549250', '2209971', '3162658', '3549409', '3162948', '3549508', '4125407', '3162955', '3163102', '5107297', '5107305', '3549706', '3549805', '5220108', '5220157', '3550100', '5220207', '5220264', '5220280', '3550407', '5107404', '3550506', '3164209', '3164308', '3164605', '3164704', '3164803', '3550902', '3165107', '5107875', '3551108', '3551306', '2930006', '5007802', '5220454', '3165909', '4126306', '3551405', '3166600', '3166808', '5107883', '3551504', '5220504', '3166956', '3167103', '3551702', '3167202', '5007901', '5220603', '5220686', '5220702', '5007935', '5107925', '3552601', '3552700', '3552908', '3553104', '3168002', '3553203', '3553302', '3553401', '5107958', '3168101', '3168200', '5108006', '3168309', '3553658', '5221007', '3553708', '3553807', '3553856', '3553955', '3554201', '4127106', '5008008', '2211001', '5221080', '5221197', '3554409', '5108105', '4127502', '3168903', '5108204', '3554706', '3554755', '5008305', '3169356', '5221304', '5221403', '5221452', '3169604', '3169703', '5221502', '5221551', '3170008', '3170107', '3170206', '3555505', '3555604', '5221577', '3170404', '2211100', '3170438', '2932606', '5221601', '5221700', '3170479', '3170529', '5221809', '5108352', '3556107', '5221858', '3170602', '3170651', '3556404', '5221908', '3170750', '3170800', '5108402', '3170909', '3171006', '4128534', '3171030', '3171071', '3171105', '3171204', '5222005', '5222054', '5222203', '5222302', '1100304', '3556800', '3171600', '3557105', '2933455', '2933604', '2100105', '2100154', '2100303', '1700350', '1700400', '2100436', '2100501', '1700707', '2200459', '2100600', '2100808', '2901403', '2200806', '1701101', '1702000', '2100907', '2100956', '1702703', '2201101', '2101202', '2902500', '2201150', '2101400', '2101509', '2101608', '2903201', '2201309', '2101707', '2101731', '2101806', '2101939', '2201705', '2201903', '2903904', '1703305', '1703701', '2102101', '2102200', '2102309', '1703842', '2906105', '2102705', '2102754', '2907103', '1703867', '2102804', '2907400', '2103000', '1704105', '1705102', '2103208', '2103307', '2103406', '2103505', '2202752', '1705557', '1705607', '2909109', '2103604', '2202901', '2909307', '2909406', '1706100', '2203008', '2203107', '2909703', '1706258', '2203206', '2203230', '1707009', '2103802', '1707306', '2103901', '2203602', '2104008', '1707553', '2104073', '2104081', '1707652', '2104099', '2911105', '1708205', '2104107', '2104206', '2204402', '1709005', '2104404', '2104503', '2104602', '2104628', '2104701', '2104800', '1709500', '2105005', '2105203', '1709807', '1710508', '2105401', '2917359', '2105450', '1711506', '2105476', '2105609', '2205524', '2105807', '2105948', '1711902', '2105922', '1711951', '1712009', '2205607', '1712157', '2106003', '1712405', '2106102', '2919553', '2106300', '2205904', '2920452', '2206001', '2106409', '1712702', '2106607', '2106631', '2106672', '1713205', '2106706', '2106755', '2206605', '1713601', '2206654', '1714203', '2107209', '2107258', '2107308', '1715002', '1715101', '1715259', '1715507', '1721000', '2207405', '1715754', '2107704', '1716109', '2207603', '2107803', '2107902', '2108009', '2108058', '2108207', '1716505', '1716604', '2108454', '1717008', '2108801', '1717503', '2108900', '1717800', '1717909', '2208551', '1718006', '1718204', '2109106', '2109304', '2109403', '1718451', '1718501', '2208700', '2109502', '2926202', '2208858', '2208908', '1718659', '1718709', '1718758', '2109700', '1718840', '2209203', '2109759', '2209302', '2928109', '1718881', '2110104', '2928406', '1718899', '1718907', '1719004', '2928208', '2110237', '2110278', '2110302', '2110401', '2110609', '2928901', '2110658', '2110708', '2110807', '2929057', '1720150', '2110906', '2209757', '2111078', '2111102', '2111250', '2111409', '2111508', '2111573', '2111607', '2111631', '2111672', '1720259', '1720499', '2210623', '2210631', '2111748', '2930154', '2930303', '1720655', '2111805', '1720853', '2111904', '2111953', '2930907', '1720903', '1720937', '1720978', '2112001', '2112100', '2112209', '1721109', '2112233', '2112308', '1721257', '2112506', '2112605', '2211209', '2112704', '5102694', '1502707', '5103353', '5103700', '5104526', '5105309', '5106778', '1506583', '5107776', '1506708', '5108501', '5108600', '1700251', '1700301', '1701002', '1701051', '1701309', '1701903', '1702109', '1702158', '1702208', '1702554', '1702901', '1703008', '1703057', '1703073', '1703107', '1703602', '1703800', '2102358', '1703826', '2102556', '1703883', '1703891', '1703909', '1704600', '2103257', '1705508', '1716703', '1706001', '1706506', '2103752', '1707108', '1707207', '2104057', '1707702', '1708254', '1708304', '2104552', '1709302', '2105302', '1710706', '1710904', '2105500', '1711803', '2105989', '1712454', '1712504', '1712801', '1713304', '1713700', '2107001', '1713957', '1714302', '1714880', '1715705', '1713809', '1716307', '1716653', '1717206', '2109007', '1718303', '1718402', '1718550', '2109551', '1718808', '1720002', '1720101', '2111052', '1720200', '2111763', '1720804', '1721208', '1721307', '2112852', '1722081', '1722107', '2930758', '5205307'];



}
